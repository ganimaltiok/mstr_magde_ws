<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cache Management - MSTR Herald</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; }
        .header h1 { font-size: 24px; }
        .header nav { margin-top: 10px; }
        .header nav a { color: #ecf0f1; text-decoration: none; margin-right: 20px; }
        .container { max-width: 900px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .stats-panel { background: #f8f9fa; padding: 20px; border-radius: 6px; margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
        .stat-box { text-align: center; }
        .stat-box .value { font-size: 32px; font-weight: bold; color: #007bff; }
        .stat-box .label { font-size: 14px; color: #666; margin-top: 5px; }
        .action-panel { margin-bottom: 20px; padding: 20px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; }
        .action-panel h3 { font-size: 16px; margin-bottom: 15px; color: #856404; }
        .action-group { margin-bottom: 15px; }
        .action-group label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; }
        .action-group select { width: 300px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn:hover { opacity: 0.9; }
        .warning-text { color: #856404; font-size: 13px; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cache Management</h1>
        <nav>
            <a href="/admin/dashboard">Dashboard</a>
            <a href="/admin/endpoints">Endpoints</a>
            <a href="/admin/cache">Cache Management</a>
        </nav>
    </div>

    <div class="container">
        <!-- Cache Statistics -->
        <div class="stats-panel">
            <h2>Cache Statistics</h2>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="value">{{ "%.1f"|format(cache_stats.total_size / 1024 / 1024) }} MB</div>
                    <div class="label">Total Size</div>
                </div>
                <div class="stat-box">
                    <div class="value">{{ cache_stats.total_files }}</div>
                    <div class="label">Total Files</div>
                </div>
                <div class="stat-box">
                    <div class="value">{{ "%.1f"|format(cache_stats.short_cache_size / 1024 / 1024) }} MB</div>
                    <div class="label">Short Cache (10min)</div>
                </div>
                <div class="stat-box">
                    <div class="value">{{ "%.1f"|format(cache_stats.daily_cache_size / 1024 / 1024) }} MB</div>
                    <div class="label">Daily Cache (7AM)</div>
                </div>
            </div>
        </div>

        <!-- Cache Actions -->
        <div class="action-panel">
            <h3>⚠️ Cache Purge Actions</h3>
            
            <div class="action-group">
                <button class="btn btn-danger" onclick="purgeAllCache()">Clear Nginx Cache</button>
                <div class="warning-text">This will clear all nginx-cached data for all endpoints (10 min cache). Use with caution!</div>
            </div>

            <div class="action-group" style="margin-top: 20px;">
                <label for="endpoint-select">Clear Endpoint Cache:</label>
                <select id="endpoint-select">
                    <option value="">-- Select Endpoint --</option>
                    {% for endpoint in endpoints %}
                    <option value="{{ endpoint }}">{{ endpoint }}</option>
                    {% endfor %}
                </select>
                <button class="btn btn-warning" onclick="purgeEndpointCache()">Clear Selected</button>
                <div class="warning-text">This will clear cached data only for the selected endpoint.</div>
            </div>
        </div>

        <div style="padding: 20px; background: #e7f3ff; border-radius: 6px; font-size: 13px; color: #004085;">
            <strong>Note:</strong> Cache purge is immediate. The next request to the endpoint will fetch fresh data and rebuild the nginx cache (10 minutes).
            This may cause slower response times until the cache is rebuilt.
        </div>
    </div>

    <script>
        async function purgeAllCache() {
            if (!confirm('Clear ALL nginx cache? This will affect all endpoints and cause slower response times until caches are rebuilt.')) {
                return;
            }

            try {
                const response = await fetch('/admin/cache/purge', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target: 'all'})
                });

                const result = await response.json();
                alert(result.message || 'Cache purged successfully');
                location.reload();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function purgeEndpointCache() {
            const endpoint = document.getElementById('endpoint-select').value;
            if (!endpoint) {
                alert('Please select an endpoint');
                return;
            }

            if (!confirm(`Clear cache for endpoint "${endpoint}"?`)) {
                return;
            }

            try {
                const response = await fetch('/admin/cache/purge', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target: 'endpoint', endpoint_name: endpoint})
                });

                const result = await response.json();
                alert(result.message || 'Cache purged successfully');
                location.reload();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
